OpenAI Codex v0.101.0 (research preview)
--------
workdir: /Users/james/Repos/wibandwob-dos
model: gpt-5.3-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: medium
reasoning summaries: auto
session id: 019c725a-235d-7f71-ba24-656c5c1c320e
--------
user
We've completed two major IPC architecture improvements to WibWob-DOS (a C++14 Turbo Vision TUI with a Python multiplayer bridge). Please review the current state and suggest any remaining improvements.

## What was done

### P0: WindowTypeRegistry (app/window_type_registry.h + .cpp)
Eliminated the 60-line if-else dispatch chain and 18 extern declarations from api_ipc.cpp. All window types now registered in one table. See app/window_type_registry.cpp.

### P1: Event Push (app/api_ipc.h + .cpp, tools/room/partykit_bridge.py)
Added subscribe_events IPC command that keeps fd open and pushes newline-delimited JSON events (state_changed, window_closed) to all subscribers. Python bridge now has event_subscribe_loop() + slow 5s heartbeat. See tools/room/partykit_bridge.py.

## Architecture context
Reference the earlier analysis in codex-architecture-review-20260218-194638.log for background.

## Key files to review
- app/window_type_registry.h + app/window_type_registry.cpp (new)
- app/api_ipc.h + app/api_ipc.cpp (modified)
- app/test_pattern_app.cpp (windowTypeName function around line 2394, api_get_state around line 2437)
- tools/room/partykit_bridge.py (event_subscribe_loop, poll_loop, receive_loop)
- tools/room/state_diff.py (windows_from_state, compute_delta, apply_delta_to_ipc)

## What to review
1. Are there remaining robustness issues in the event push implementation? (fd lifecycle, EAGAIN handling, subscriber cleanup)
2. Is there a race condition in the Python bridge between event_subscribe_loop and poll_loop updating last_windows?
3. Are there any correctness issues in window_type_registry.cpp?
4. What is the next highest-value improvement? Consider: P2 (IWindowTyped mixin), P3 (JSON dual-stack IPC), or anything else found in review.
5. Is there anything that could cause multiplayer sync to fail silently?

Please read the actual files before answering. Show exact code issues and concrete fixes.
mcp startup: no servers
2026-02-18T20:03:55.922061Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c67d3-e7fb-7423-879a-a3c6997f29d4
2026-02-18T20:03:55.946757Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6171-ccc2-7702-9b67-9c22338e3137
2026-02-18T20:03:55.962033Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6248-4000-77b0-815a-4015ebbba891

thinking
**Preparing code review approach**
codex
I’ll do a focused code review of the listed files and verify the event push/data-race/correctness concerns against the actual implementation, then return prioritized findings with exact file/line references and concrete fixes. I’m starting by opening those files and the referenced architecture log.
exec
/bin/zsh -lc "rg --files app tools/room | rg 'window_type_registry|api_ipc|test_pattern_app|partykit_bridge|state_diff'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "rg --files | rg 'codex-architecture-review-20260218-194638\\.log'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'ls -la' in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
app/api_ipc.cpp
app/api_ipc.h
app/window_type_registry.cpp
app/window_type_registry.h
tools/room/partykit_bridge.py
tools/room/state_diff.py
app/test_pattern_app.cpp
 succeeded in 50ms:
codex-architecture-review-20260218-194638.log
 succeeded in 52ms:
total 552
drwxr-xr-x@  41 james  staff   1312 Feb 18 20:03 .
drwxr-xr-x   35 james  staff   1120 Feb 17 19:48 ..
-rw-r--r--@   1 james  staff   8196 Feb 17 18:59 .DS_Store
drwxr-xr-x@   3 james  staff     96 Feb 16 08:49 .agents
drwxr-xr-x@   7 james  staff    224 Feb 17 19:48 .claude
drwxr-xr-x@   5 james  staff    160 Feb 16 08:49 .codex
-rw-r--r--@   1 james  staff    129 Feb 17 18:26 .env
drwxr-xr-x@  17 james  staff    544 Feb 18 20:03 .git
drwxr-xr-x@   5 james  staff    160 Feb 16 08:49 .github
-rw-r--r--@   1 james  staff    493 Feb 17 17:57 .gitignore
-rw-r--r--@   1 james  staff    376 Feb 15 19:38 .gitmodules
drwxr-xr-x@   6 james  staff    192 Feb 18 17:44 .planning
drwxr-xr-x@   6 james  staff    192 Feb 15 09:36 .pytest_cache
drwxr-xr-x@   3 james  staff     96 Feb 15 07:50 .zed
-rw-r--r--@   1 james  staff   5130 Feb 16 09:25 AGENTS.md
-rw-r--r--@   1 james  staff  11461 Feb 17 20:00 CLAUDE.md
-rw-r--r--@   1 james  staff    306 Feb 15 19:38 CMakeLists.txt
-rw-r--r--@   1 james  staff   6393 Feb 18 19:50 CODEX-ANALYSIS-ARCHITECTURE-REVIEW.md
-rw-r--r--@   1 james  staff  10005 Feb 17 17:57 README.md

thinking
**Planning file inspection with line numbers**
codex
I found all target files; next I’m reading them with line numbers so I can point to exact defects and not just high-level concerns.
exec
/bin/zsh -lc 'nl -ba app/window_type_registry.h' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'nl -ba app/window_type_registry.cpp' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'nl -ba app/api_ipc.h' in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
     1	// Data-driven registry mapping window type slugs to spawn callbacks.
     2	// Eliminates the if-else dispatch chain and extern declarations in api_ipc.cpp.
     3	// To add a new window type: add ONE entry in window_type_registry.cpp.
     4	#pragma once
     5	
     6	#include <string>
     7	#include <vector>
     8	#include <map>
     9	
    10	class TTestPatternApp;
    11	
    12	// Spawn callback: return nullptr on success, a static error string on failure.
    13	using WinSpawnFn = const char* (*)(TTestPatternApp&,
    14	                                   const std::map<std::string, std::string>&);
    15	
    16	struct WindowTypeSpec {
    17	    const char* type;    // canonical slug, e.g. "verse", "gradient"
    18	    WinSpawnFn  spawn;   // nullptr = recognised but not creatable via IPC
    19	};
    20	
 succeeded in 51ms:
     1	// Window type registry — single source of truth for all spawnable window types.
     2	// Keeps api_ipc.cpp free of per-type knowledge: adding a new type only requires
     3	// a new entry in the k_specs table below.
     4	
     5	#include "window_type_registry.h"
     6	
     7	// tvision for TRect
     8	#define Uses_TRect
     9	#include <tvision/tv.h>
    10	
    11	#include <cstdlib>  // atoi
    12	#include <cstring>  // strcmp
    13	
    14	// ── Extern declarations for spawn helpers in test_pattern_app.cpp ─────────────
    15	
    16	class TTestPatternApp; // forward decl (full type used only by called functions)
    17	
    18	extern void api_spawn_test(TTestPatternApp&, const TRect*);
    19	extern void api_spawn_gradient(TTestPatternApp&, const std::string&, const TRect*);
    20	extern void api_open_animation_path(TTestPatternApp&, const std::string&, const TRect*);
exec
/bin/zsh -lc 'nl -ba app/api_ipc.cpp' in /Users/james/Repos/wibandwob-dos succeeded in 50ms:
     1	// Unix domain socket IPC server with optional HMAC challenge-response auth.
     2	// Protocol: cmd:<name> [key=value ...]\n
     3	// Auth: when WIBWOB_AUTH_SECRET is set, new connections must complete a
     4	//       challenge-response handshake before commands are accepted.
     5	#pragma once
     6	
     7	#include <string>
     8	#include <set>
     9	#include <vector>
    10	#include <cstdint>
    11	
    12	class TTestPatternApp;
    13	
    14	class ApiIpcServer {
    15	public:
    16	    explicit ApiIpcServer(TTestPatternApp* app);
    17	    ~ApiIpcServer();
    18	
    19	    // Start listening on a Unix socket path. Returns false on failure.
    20	    bool start(const std::string& path = "/tmp/test_pattern_app.sock");
 succeeded in 51ms:
     1	#include "api_ipc.h"
     2	#include "command_registry.h"
     3	#include "window_type_registry.h"
     4	
     5	#ifndef _WIN32
     6	#include <sys/socket.h>
     7	#include <sys/stat.h>
     8	#include <sys/un.h>
     9	#include <fcntl.h>
    10	#include <unistd.h>
    11	#include <errno.h>
    12	#endif
    13	
    14	#ifdef __APPLE__
    15	#include <CommonCrypto/CommonHMAC.h>
    16	#else
    17	#include <openssl/hmac.h>
    18	#endif
    19	
    20	#include <cstring>
exec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '2330,2515p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'nl -ba tools/room/state_diff.py' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba codex-architecture-review-20260218-194638.log | sed -n '1,260p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'nl -ba tools/room/partykit_bridge.py' in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
  2330	
  2331	std::string api_scramble_say(TTestPatternApp& app, const std::string& text) {
  2332	    if (!app.scrambleWindow) return "err scramble not open";
  2333	    // Simulate user sending a message — same as onSubmit
  2334	    auto* msgView = app.scrambleWindow->getMessageView();
  2335	    if (msgView) msgView->addMessage("you", text);
  2336	
  2337	    std::string response = app.scrambleEngine.ask(text);
  2338	    if (response.empty()) response = "... (=^..^=)";
  2339	
  2340	    if (app.scrambleWindow->getView()) {
  2341	        app.scrambleWindow->getView()->setPose(spCurious);
  2342	        app.scrambleWindow->getView()->say(response);
  2343	    }
  2344	    if (msgView) msgView->addMessage("scramble", response);
  2345	    return response;
  2346	}
  2347	std::string api_scramble_pet(TTestPatternApp& app) {
  2348	    if (!app.scrambleWindow) return "err scramble not open";
  2349	
 succeeded in 52ms:
     1	"""
     2	State diffing utilities for WibWob-DOS multiplayer sync (E008 F03).
     3	
     4	Extracts window state from IPC get_state responses, computes minimal
     5	add/remove/update deltas, and applies remote deltas to a local instance
     6	via IPC commands.
     7	
     8	Used by partykit_bridge.py and any future sync transport.
     9	"""
    10	
    11	import hashlib
    12	import json
    13	import socket
    14	import os
    15	from typing import Any
    16	
    17	
    18	IPC_TIMEOUT = 2.0
    19	
    20	
 succeeded in 52ms:
     1	OpenAI Codex v0.101.0 (research preview)
     2	--------
     3	workdir: /Users/james/Repos/wibandwob-dos
     4	model: gpt-5.3-codex
     5	provider: openai
     6	approval: never
     7	sandbox: workspace-write [workdir, /tmp, $TMPDIR]
     8	reasoning effort: medium
     9	reasoning summaries: auto
    10	session id: 019c724a-5126-7721-aa72-ea988309487f
    11	--------
    12	user
    13	
    14	Read /Users/james/Repos/wibandwob-dos/codex-window-types-20260218-193804.log for full context, then read:
    15	- app/test_pattern_app.cpp (architecture overview, class structure)
    16	- app/api_ipc.cpp (IPC protocol)
    17	- CLAUDE.md (project overview)
    18	- app/command_registry.h and app/command_registry.cpp (command registry)
    19	
    20	CONTEXT:
 succeeded in 51ms:
     1	#!/usr/bin/env python3
     2	# /// script
     3	# requires-python = ">=3.11"
     4	# dependencies = ["websockets>=12"]
     5	# ///
     6	"""
     7	PartyKit bridge for WibWob-DOS multiplayer rooms (E008 F02).
     8	
     9	Runs as a sidecar alongside a WibWob instance. Polls local IPC state,
    10	diffs it, and pushes state_delta messages to PartyKit. Also receives
    11	remote deltas from PartyKit and applies them to the local instance via IPC.
    12	
    13	Usage (spawned by orchestrator):
    14	    uv run tools/room/partykit_bridge.py
    15	
    16	Environment:
    17	    WIBWOB_INSTANCE      — instance ID (e.g. "1"), drives /tmp/wibwob_1.sock
    18	    WIBWOB_PARTYKIT_URL  — PartyKit server URL (e.g. https://wibwob.user.partykit.dev)
    19	    WIBWOB_PARTYKIT_ROOM — PartyKit room/Durable Object key (e.g. "wibwob-shared")
    20	    WIBWOB_AUTH_SECRET   — shared HMAC secret for IPC auth (optional)

thinking
**Searching event publish usage**
codex
I’ve read the core files; now I’m checking call sites and synchronization paths (where `publish_event` is invoked, where `last_windows` mutates) to confirm concrete race/failure modes.
exec
/bin/zsh -lc 'rg -n "last_windows|last_chat_seq|_sync_state_now|poll_loop|event_subscribe_loop|receive_loop|apply_delta_to_ipc" tools/room/partykit_bridge.py tools/room/state_diff.py' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'rg -n "registerWindow|winToId|idToWin|findWindowById|close_window|move_window|resize_window" app/test_pattern_app.cpp app/api_ipc.cpp' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'rg -n "publish_event|subscribe_events|state_changed|window_closed|event_subscribers_|next_event_seq_" app tools/room' in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
app/api_ipc.cpp:114:extern std::string api_move_window(TTestPatternApp& app, const std::string& id, int x, int y);
app/api_ipc.cpp:115:extern std::string api_resize_window(TTestPatternApp& app, const std::string& id, int width, int height);
app/api_ipc.cpp:117:extern std::string api_close_window(TTestPatternApp& app, const std::string& id);
app/api_ipc.cpp:403:    } else if (cmd == "move_window") {
app/api_ipc.cpp:410:            resp = api_move_window(*app_, id->second, x, y) + "\n";
app/api_ipc.cpp:414:    } else if (cmd == "resize_window") {
app/api_ipc.cpp:421:            resp = api_resize_window(*app_, id->second, width, height) + "\n";
app/api_ipc.cpp:432:    } else if (cmd == "close_window") {
app/api_ipc.cpp:435:            resp = api_close_window(*app_, id->second) + "\n";
app/test_pattern_app.cpp:633:    std::map<TWindow*, std::string> winToId;
app/test_pattern_app.cpp:634:    std::map<std::string, TWindow*> idToWin;
app/test_pattern_app.cpp:636:    std::string registerWindow(TWindow* w) {
app/test_pattern_app.cpp:638:        auto it = winToId.find(w);
app/test_pattern_app.cpp:639:        if (it != winToId.end()) return it->second;
app/test_pattern_app.cpp:643:        winToId[w] = id;
app/test_pattern_app.cpp:644:        idToWin[id] = w;
app/test_pattern_app.cpp:653:    TWindow* findWindowById(const std::string& id) {
app/test_pattern_app.cpp:654:        auto it = idToWin.find(id);
app/test_pattern_app.cpp:655:        if (it != idToWin.end()) return it->second;
app/test_pattern_app.cpp:658:        winToId.clear();
 succeeded in 51ms:
tools/room/state_diff.py:191:def apply_delta_to_ipc(sock_path: str, delta: dict[str, Any]) -> list[str]:
tools/room/partykit_bridge.py:34:    apply_delta_to_ipc,
tools/room/partykit_bridge.py:70:        self.last_windows: dict[str, dict] = {}
tools/room/partykit_bridge.py:71:        self.last_chat_seq: int = 0
tools/room/partykit_bridge.py:99:    async def _sync_state_now(self, trigger: str = "poll") -> dict | None:
tools/room/partykit_bridge.py:108:        delta = compute_delta(self.last_windows, new_windows)
tools/room/partykit_bridge.py:112:            self.last_windows = new_windows
tools/room/partykit_bridge.py:115:    async def event_subscribe_loop(self) -> None:
tools/room/partykit_bridge.py:140:                            await self._sync_state_now(f"event:{event_name}")
tools/room/partykit_bridge.py:146:    async def poll_loop(self) -> None:
tools/room/partykit_bridge.py:149:            state = await self._sync_state_now("heartbeat")
tools/room/partykit_bridge.py:154:                    if seq > self.last_chat_seq:
tools/room/partykit_bridge.py:160:                        self.last_chat_seq = seq
tools/room/partykit_bridge.py:163:    async def receive_loop(self, ws) -> None:
tools/room/partykit_bridge.py:176:                    delta = compute_delta(self.last_windows, new_windows)
tools/room/partykit_bridge.py:179:                        apply_delta_to_ipc(self.sock_path, delta)
tools/room/partykit_bridge.py:184:                        self.last_windows = windows_from_state(actual) if actual else new_windows
tools/room/partykit_bridge.py:189:                    applied = apply_delta_to_ipc(self.sock_path, delta)
tools/room/partykit_bridge.py:195:                        self.last_windows = windows_from_state(actual)
tools/room/partykit_bridge.py:219:                        self.poll_loop(),
 succeeded in 51ms:
tools/room/partykit_bridge.py:120:                writer.write(b"cmd:subscribe_events\n")
tools/room/partykit_bridge.py:139:                        if event_name in ("state_changed", "window_closed"):
app/api_ipc.h:28:    void publish_event(const char* event_type, const std::string& payload_json = "{}");
app/api_ipc.h:38:    std::vector<int> event_subscribers_;
app/api_ipc.h:39:    uint64_t next_event_seq_ = 1;
app/api_ipc.cpp:555:    if (cmd == "subscribe_events") {
app/api_ipc.cpp:557:        // Set non-blocking so publish_event doesn't stall the event loop.
app/api_ipc.cpp:562:        event_subscribers_.push_back(fd);
app/api_ipc.cpp:571:void ApiIpcServer::publish_event(const char* event_type, const std::string& payload_json) {
app/api_ipc.cpp:573:    if (event_subscribers_.empty()) return;
app/api_ipc.cpp:575:                    + std::to_string(next_event_seq_++)
app/api_ipc.cpp:579:    for (auto it = event_subscribers_.begin(); it != event_subscribers_.end(); ) {
app/api_ipc.cpp:583:            it = event_subscribers_.erase(it);
app/api_ipc.cpp:594:    for (int sub_fd : event_subscribers_) ::close(sub_fd);
app/api_ipc.cpp:595:    event_subscribers_.clear();
app/test_pattern_app.cpp:648:            ipcServer->publish_event("state_changed", payload);
app/test_pattern_app.cpp:2520:        app.ipcServer->publish_event("state_changed", payload);
app/test_pattern_app.cpp:2536:        app.ipcServer->publish_event("state_changed", payload);
app/test_pattern_app.cpp:2560:        app.ipcServer->publish_event("window_closed", payload);

thinking
**Exploring publish and register logic**
codex
I found `publish_event` call sites; I’m now drilling into those exact regions to validate lifecycle behavior (ID assignment, close/remove ordering, and emitted payload content).
exec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '2500,2588p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '600,730p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '1210,1325p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
  2500	        if (!firstChat) json << ",";
  2501	        json << "{\"seq\":" << entry.seq
  2502	             << ",\"sender\":\"" << TTestPatternApp::jsonEscape(entry.sender) << "\""
  2503	             << ",\"text\":\"" << TTestPatternApp::jsonEscape(entry.text) << "\"}";
  2504	        firstChat = false;
  2505	    }
  2506	    json << "]}";
  2507	    return json.str();
  2508	}
  2509	
  2510	std::string api_move_window(TTestPatternApp& app, const std::string& id, int x, int y) {
  2511	    TWindow* w = app.findWindowById(id);
  2512	    if (!w) return "{\"error\":\"Window not found\"}";
  2513	
  2514	    TRect newBounds = w->getBounds();
  2515	    newBounds.move(x - newBounds.a.x, y - newBounds.a.y);
  2516	    w->locate(newBounds);
  2517	
  2518	    if (app.ipcServer) {
  2519	        std::string payload = std::string("{\"id\":\"") + id + "\"}";
 succeeded in 52ms:
   600	    int windowNumber;
   601	    static const int maxWindows = 99;
   602	
   603	    // Scramble cat overlay
   604	    TScrambleWindow* scrambleWindow;
   605	    ScrambleEngine scrambleEngine;
   606	    ScrambleDisplayState scrambleState;
   607	    void toggleScramble();
   608	    void toggleScrambleExpand();
   609	    void wireScrambleInput();
   610	
   611	    // Runtime API key (shared across all chat windows)
   612	    static std::string runtimeApiKey;
   613	    friend std::string getAppRuntimeApiKey();
   614	
   615	    // Kaomoji mood helper
   616	    void setKaomojiMood(TCustomMenuBar::KaomojiMood mood, int durationMs = 2000) {
   617	        if (menuBar) {
   618	            auto* customMenuBar = dynamic_cast<TCustomMenuBar*>(menuBar);
   619	            if (customMenuBar) {
 succeeded in 51ms:
  1210	            case cmGlitchSettings:
  1211	                messageBox("Glitch Settings dialog coming soon!\n\nUse menu items to adjust parameters for now.", mfInformation | mfOKButton);
  1212	                clearEvent(event);
  1213	                break;
  1214	                
  1215	            // Future File commands
  1216	            case cmOpenAnsiArt:
  1217	                messageBox("ANSI Art file opening coming soon!", mfInformation | mfOKButton);
  1218	                clearEvent(event);
  1219	                break;
  1220	            case cmNewPaintCanvas:
  1221	                messageBox("Paint Canvas creation coming soon!", mfInformation | mfOKButton);
  1222	                clearEvent(event);
  1223	                break;
  1224	            case cmOpenImageFile: {
  1225	                char fileName[MAXPATH];
  1226	                strcpy(fileName, "*.{png,jpg,jpeg}");
  1227	                TFileDialog* dialog = new TFileDialog("*.{png,jpg,jpeg}", "Open Image File", "~N~ame", fdOpenButton, 101);
  1228	                if (executeDialog(dialog, fileName) != cmCancel) {
  1229	                    windowNumber++;

thinking
**Inspecting event handling inconsistencies**
exec
/bin/zsh -lc "nl -ba tools/room/partykit_bridge.py | sed -n '90,175p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
    90	            return
    91	        msg = json.dumps({"type": "chat_msg", "sender": sender, "text": text,
    92	                          "instance": self.instance_id})
    93	        try:
    94	            await self._ws.send(msg)
    95	        except Exception as e:
    96	            self.log(f"send error (chat): {e}")
    97	            self._ws = None
    98	
    99	    async def _sync_state_now(self, trigger: str = "poll") -> dict | None:
   100	        """Fetch local IPC state, diff against baseline, push delta if changed.
   101	
   102	        Returns the raw state dict (for callers that also need it), or None on error.
   103	        """
   104	        state = ipc_get_state(self.sock_path)
   105	        if not state:
   106	            return None
   107	        new_windows = windows_from_state(state)
   108	        delta = compute_delta(self.last_windows, new_windows)
   109	        if delta:
exec
/bin/zsh -lc "nl -ba tools/room/partykit_bridge.py | sed -n '175,240p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
   175	                    new_windows = dict(windows)
   176	                    delta = compute_delta(self.last_windows, new_windows)
   177	                    if delta:
   178	                        self.log(f"applying state_sync delta")
   179	                        apply_delta_to_ipc(self.sock_path, delta)
   180	                        # Re-read actual local state as baseline — C++ assigns its
   181	                        # own window IDs, so we must not track remote IDs or the
   182	                        # poll loop will see a mismatch and re-broadcast forever.
   183	                        actual = ipc_get_state(self.sock_path)
   184	                        self.last_windows = windows_from_state(actual) if actual else new_windows
   185	
   186	            elif mtype == "state_delta":
   187	                delta = msg.get("delta", {})
   188	                if delta:
   189	                    applied = apply_delta_to_ipc(self.sock_path, delta)
   190	                    for cmd in applied:
   191	                        self.log(f"  {'✓' if not cmd.startswith('FAIL') else '✗'} {cmd}")
   192	                    # Re-read actual local state as baseline to prevent re-broadcast loop.
   193	                    actual = ipc_get_state(self.sock_path)
   194	                    if actual:

thinking
**Investigating window type registrations**
codex
Next I’m verifying registry correctness end-to-end by comparing `window_type_registry` entries with actual spawn helpers and `windowTypeName()` outputs to catch mismatches or missing types.
exec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '3170,3325p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "rg -n \"cmd == \\\"chat_receive\\\"|chat_receive|exec_command\\\"\" app/api_ipc.cpp app/command_registry.cpp app/command_registry.h" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'rg -n "''^void api_spawn_|''^void api_open_|windowTypeName'"\\(|return \\\"[a-z_]+\\\";\" app/test_pattern_app.cpp app/window_type_registry.cpp | sed -n '1,220p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
  3170	    }
  3171	    
  3172	    // If we have a text editor, send the figlet text
  3173	    if (editorWindow) {
  3174	        // Focus the window
  3175	        editorWindow->select();
  3176	        
  3177	        // Send the figlet text
  3178	        TTextEditorView* editorView = editorWindow->getEditorView();
  3179	        if (editorView) {
  3180	            editorView->sendFigletText(text, font, width, mode);
  3181	            return "ok";
  3182	        }
  3183	    }
  3184	
  3185	    return "err no text editor available";
  3186	}
  3187	
  3188	void api_spawn_browser(TTestPatternApp& app, const TRect* bounds) {
  3189	    if (bounds) {
 succeeded in 52ms:
app/api_ipc.cpp:360:    } else if (cmd == "exec_command") {
app/command_registry.cpp:12:extern std::string api_chat_receive(TTestPatternApp& app, const std::string& sender, const std::string& text);
app/command_registry.cpp:39:        {"chat_receive", "Display a remote chat message in Scramble (sender + text params)", true},
app/command_registry.cpp:146:    if (name == "chat_receive") {
app/command_registry.cpp:152:        return api_chat_receive(app, sender, itText->second);
 succeeded in 52ms:
app/test_pattern_app.cpp:129:    return "primers";
app/test_pattern_app.cpp:2258:void api_spawn_test(TTestPatternApp& app) { app.newTestWindow(); }
app/test_pattern_app.cpp:2259:void api_spawn_gradient(TTestPatternApp& app, const std::string& kind) {
app/test_pattern_app.cpp:2266:void api_open_animation_path(TTestPatternApp& app, const std::string& path) {
app/test_pattern_app.cpp:2271:void api_spawn_test(TTestPatternApp& app, const TRect* bounds) { 
app/test_pattern_app.cpp:2279:void api_spawn_gradient(TTestPatternApp& app, const std::string& kind, const TRect* bounds) {
app/test_pattern_app.cpp:2293:void api_open_text_view_path(TTestPatternApp& app, const std::string& path, const TRect* bounds) {
app/test_pattern_app.cpp:2319:void api_open_animation_path(TTestPatternApp& app, const std::string& path, const TRect* bounds) {
app/test_pattern_app.cpp:2374:    return "ok";
app/test_pattern_app.cpp:2394:static const char* windowTypeName(TWindow* w) {
app/test_pattern_app.cpp:2395:    if (!w) return "test_pattern";
app/test_pattern_app.cpp:2398:    if (dynamic_cast<TTestPatternWindow*>(w))    return "test_pattern";
app/test_pattern_app.cpp:2399:    if (dynamic_cast<TGradientWindow*>(w))        return "gradient";
app/test_pattern_app.cpp:2400:    if (dynamic_cast<TBrowserWindow*>(w))         return "browser";
app/test_pattern_app.cpp:2401:    if (dynamic_cast<TTextEditorWindow*>(w))      return "text_editor";
app/test_pattern_app.cpp:2402:    if (dynamic_cast<TTransparentTextWindow*>(w)) return "text_view";
app/test_pattern_app.cpp:2403:    if (dynamic_cast<TFrameAnimationWindow*>(w))  return "frame_player";
app/test_pattern_app.cpp:2404:    if (dynamic_cast<TWibWobWindow*>(w))          return "wibwob";
app/test_pattern_app.cpp:2405:    if (dynamic_cast<TScrambleWindow*>(w))        return "scramble";
app/test_pattern_app.cpp:2419:    if (HAS_CHILD_VIEW(TGenerativeVerseView))         return "verse";

thinking
**Identifying IPC command percent-encoding bug**
exec
/bin/zsh -lc "nl -ba app/command_registry.cpp | sed -n '1,220p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
     1	#include "command_registry.h"
     2	
     3	#include "api_ipc.h"
     4	
     5	#include <sstream>
     6	
     7	extern void api_cascade(TTestPatternApp& app);
     8	extern void api_toggle_scramble(TTestPatternApp& app);
     9	extern void api_expand_scramble(TTestPatternApp& app);
    10	extern std::string api_scramble_say(TTestPatternApp& app, const std::string& text);
    11	extern std::string api_scramble_pet(TTestPatternApp& app);
    12	extern std::string api_chat_receive(TTestPatternApp& app, const std::string& sender, const std::string& text);
    13	extern void api_tile(TTestPatternApp& app);
    14	extern void api_close_all(TTestPatternApp& app);
    15	extern void api_save_workspace(TTestPatternApp& app);
    16	extern bool api_open_workspace_path(TTestPatternApp& app, const std::string& path);
    17	extern void api_screenshot(TTestPatternApp& app);
    18	extern void api_set_pattern_mode(TTestPatternApp& app, const std::string& mode);
    19	extern std::string api_set_theme_mode(TTestPatternApp& app, const std::string& mode);
    20	extern std::string api_set_theme_variant(TTestPatternApp& app, const std::string& variant);

thinking
**Analyzing silent multiplayer sync failures**
exec
/bin/zsh -lc "rg -n \"SIGPIPE|signal\\(|MSG_NOSIGNAL|SO_NOSIGPIPE\" app tools | sed -n '1,120p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
tools/room/orchestrator.py:239:        def handle_signal(signum, frame):
tools/room/orchestrator.py:243:        signal.signal(signal.SIGINT, handle_signal)
tools/room/orchestrator.py:244:        signal.signal(signal.SIGTERM, handle_signal)
app/tools/face_worker.py:66:    signal.signal(signal.SIGINT, cleanup)
app/tools/face_worker.py:67:    signal.signal(signal.SIGTERM, cleanup)

thinking
**Investigating SIGPIPE handling**
exec
/bin/zsh -lc "rg -n \"SIGPIPE|SO_NOSIGPIPE|signal\\(\" app/*.cpp app/*.h" in /Users/james/Repos/wibandwob-dos exited 1 in 52ms:


thinking
**Assessing event subscription and auth handling**
exec
/bin/zsh -lc 'rg -n "WIBWOB_AUTH_SECRET|challenge|auth_ok|hmac|nonce" tools/room/partykit_bridge.py tools/room/state_diff.py tools/room/*.py' in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
tools/room/partykit_bridge.py:20:    WIBWOB_AUTH_SECRET   — shared HMAC secret for IPC auth (optional)
tools/room/orchestrator.py:84:        env["WIBWOB_AUTH_SECRET"] = auth_secret
tools/room/partykit_bridge.py:20:    WIBWOB_AUTH_SECRET   — shared HMAC secret for IPC auth (optional)

thinking
**Identifying silent auth failures**
exec
/bin/zsh -lc "nl -ba tools/room/orchestrator.py | sed -n '55,105p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
    55	    def __init__(self, project_root: Path = PROJECT_ROOT):
    56	        self.project_root = project_root
    57	        self.rooms: dict[str, RoomProcess] = {}
    58	        self._running = False
    59	        self._state_file = Path("/tmp/wibwob_orchestrator.json")
    60	
    61	    def load_configs(self, config_paths: list[Path]) -> list[RoomConfig]:
    62	        """Parse and validate room configs."""
    63	        configs = []
    64	        for path in config_paths:
    65	            try:
    66	                config = parse_room_config(path, check_files=False)
    67	                configs.append(config)
    68	                print(f"[orch] Loaded: {config.room_id} (instance={config.instance_id}, port={config.ttyd_port})")
    69	            except ValueError as e:
    70	                print(f"[orch] SKIP: {path}: {e}", file=sys.stderr)
    71	        return configs
    72	
    73	    def generate_secret(self) -> str:
    74	        """Generate a 32-byte hex shared secret for agent auth."""

thinking
**Investigating environment inheritance for bridge process**
exec
/bin/zsh -lc 'rg -n "partykit_bridge|WIBWOB_PARTYKIT|uv run tools/room/partykit_bridge.py|bridge" tools/room/orchestrator.py' in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
93:            env["WIBWOB_PARTYKIT_URL"] = config.partykit_server
94:            env["WIBWOB_PARTYKIT_ROOM"] = config.partykit_room
128:        # Spawn PartyKit bridge sidecar for multiplayer rooms
130:            bridge_log = f"/tmp/wibwob_{config.instance_id}_bridge.log"
131:            bridge_cmd = [
133:                str(self.project_root / "tools" / "room" / "partykit_bridge.py"),
136:                bridge_cmd,
138:                stdout=open(bridge_log, "a"),
141:            print(f"[orch] Spawned PartyKit bridge for {config.room_id} -> {config.partykit_server}/party/{config.partykit_room}")
exec
/bin/zsh -lc "nl -ba tools/room/orchestrator.py | sed -n '118,150p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
   118	        )
   119	
   120	        room = RoomProcess(
   121	            config=config,
   122	            ttyd_proc=proc,
   123	            auth_secret=auth_secret,
   124	            start_time=time.time(),
   125	        )
   126	        self.rooms[config.room_id] = room
   127	
   128	        # Spawn PartyKit bridge sidecar for multiplayer rooms
   129	        if config.multiplayer and config.partykit_server and config.partykit_room:
   130	            bridge_log = f"/tmp/wibwob_{config.instance_id}_bridge.log"
   131	            bridge_cmd = [
   132	                "uv", "run",
   133	                str(self.project_root / "tools" / "room" / "partykit_bridge.py"),
   134	            ]
   135	            subprocess.Popen(
   136	                bridge_cmd,
   137	                env=env,

thinking
**Identifying concurrency and auth failures**
exec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '2248,2310p'" in /Users/james/Repos/wibandwob-dos succeeded in 53ms:
  2248	
  2249	int main()
  2250	{
  2251	    TTestPatternApp app;
  2252	    app.run();
  2253	    return 0;
  2254	}
  2255	
  2256	// ---- IPC API helper functions (friend) ----
  2257	// Backward compatibility overloads
  2258	void api_spawn_test(TTestPatternApp& app) { app.newTestWindow(); }
  2259	void api_spawn_gradient(TTestPatternApp& app, const std::string& kind) {
  2260	    if (kind == "horizontal") app.newGradientWindow(TGradientWindow::gtHorizontal);
  2261	    else if (kind == "vertical") app.newGradientWindow(TGradientWindow::gtVertical);
  2262	    else if (kind == "radial") app.newGradientWindow(TGradientWindow::gtRadial);
  2263	    else if (kind == "diagonal") app.newGradientWindow(TGradientWindow::gtDiagonal);
  2264	    else app.newGradientWindow(TGradientWindow::gtHorizontal);
  2265	}
  2266	void api_open_animation_path(TTestPatternApp& app, const std::string& path) {
  2267	    app.openAnimationFilePath(path);

thinking
**Identifying possible API path bug**
exec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '2290,2345p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
  2290	    }
  2291	}
  2292	
  2293	void api_open_text_view_path(TTestPatternApp& app, const std::string& path, const TRect* bounds) {
  2294	    if (bounds) {
  2295	        int width = bounds->b.x - bounds->a.x;
  2296	        int height = bounds->b.y - bounds->a.y;
  2297	        
  2298	        if (width > 0 && height > 0) {
  2299	            // Use provided bounds if width/height are positive
  2300	            app.openAnimationFilePath(path, *bounds);
  2301	        } else {
  2302	            // Auto-size based on content, but use provided position
  2303	            TRect autoBounds = app.calculateWindowBounds(path);
  2304	            // Keep the original position, but use auto-calculated size
  2305	            TRect finalBounds(
  2306	                bounds->a.x, 
  2307	                bounds->a.y, 
  2308	                bounds->a.x + (autoBounds.b.x - autoBounds.a.x), 
  2309	                bounds->a.y + (autoBounds.b.y - autoBounds.a.y)

thinking
**Identifying text view spawn bug**
exec
/bin/zsh -lc "rg -n \"openTransparentText|TransparentText|openAnimationFilePath\\(\" app/test_pattern_app.cpp | sed -n '1,220p'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
155:const ushort cmOpenTransparentText = 116;
573:    void openAnimationFilePath(const std::string& path);
574:    void openAnimationFilePath(const std::string& path, const TRect& bounds);
575:    void openTransparentTextFile();
816:            case cmOpenTransparentText:
817:                openTransparentTextFile();
1753:void TTestPatternApp::openAnimationFilePath(const std::string& filePath)
1776:void TTestPatternApp::openAnimationFilePath(const std::string& filePath, const TRect& bounds)
1797:void TTestPatternApp::openTransparentTextFile()
1826:        TTransparentTextWindow* window = new TTransparentTextWindow(bounds, title.str(), filePath);
2056:            *new TMenuItem("~O~pen Text File (Transparent BG)...", cmOpenTransparentText, kbNoKey) +
2267:    app.openAnimationFilePath(path);
2300:            app.openAnimationFilePath(path, *bounds);
2311:            app.openAnimationFilePath(path, finalBounds);
2315:        app.openAnimationFilePath(path);
2321:        app.openAnimationFilePath(path, *bounds);
2323:        app.openAnimationFilePath(path);
2402:    if (dynamic_cast<TTransparentTextWindow*>(w)) return "text_view";

thinking
**Assessing missing transparent text path**
exec
/bin/zsh -lc "rg -n \"TransparentText.*Path|open.*Text.*Path|TTransparentTextWindow\\(\" app/test_pattern_app.cpp app/*.h" in /Users/james/Repos/wibandwob-dos succeeded in 53ms:
app/test_pattern_app.cpp:1826:        TTransparentTextWindow* window = new TTransparentTextWindow(bounds, title.str(), filePath);
app/transparent_text_view.h:34:    TTransparentTextView(const TRect& bounds, const std::string& filePath);
app/transparent_text_view.h:66:    TTransparentTextWindow(const TRect& bounds, const std::string& title,

thinking
**Summarizing critical IPC protocol flaws**
codex
I’ve identified several concrete failure paths (including one critical auth mismatch). I’m doing one final pass for registry/table consistency and duplicate type slugs before I summarize prioritized fixes.
exec
/bin/zsh -lc "python - <<'PY'
import re
from collections import Counter
s=open('app/window_type_registry.cpp').read().splitlines()
pat=re.compile(r'\\{\\s*\"([a-z_]+)\"\\s*,')
vals=[pat.search(l).group(1) for l in s if pat.search(l)]
print('count',len(vals))
for k,v in Counter(vals).items():
    if v>1: print('dup',k,v)
print('types',','.join(vals))
PY" in /Users/james/Repos/wibandwob-dos exited 127 in 52ms:
zsh:1: command not found: python

thinking
**Shifting from Python to Awk for analysis**
exec
/bin/zsh -lc "awk 'match("'$0,/'"\\{[[:space:]]*\"([a-z_]+)\"[[:space:]]*,/,m){print m[1]}' app/window_type_registry.cpp | sort | uniq -cd; echo '---'; awk 'match("'$0,/'"\\{[[:space:]]*\"([a-z_]+)\"[[:space:]]*,/,m){print m[1]}' app/window_type_registry.cpp | wc -l" in /Users/james/Repos/wibandwob-dos succeeded in 53ms:
awk: syntax error at source line 1
 context is
	 >>> match($0,/\{[[:space:]]*"([a-z_]+)"[[:space:]]*,/, <<< 
awk: bailing out at source line 1
---
awk: syntax error at source line 1
 context is
	 >>> match($0,/\{[[:space:]]*"([a-z_]+)"[[:space:]]*,/, <<< 
awk: bailing out at source line 1
       0

thinking
**Switching to simpler regex extraction**
exec
/bin/zsh -lc "rg -o '\"[a-z_]+\"\\s*,' app/window_type_registry.cpp | sed 's/[\", ]//g' | sort | uniq -cd; echo '---'; rg -o '\"[a-z_]+\"\\s*,' app/window_type_registry.cpp | wc -l" in /Users/james/Repos/wibandwob-dos succeeded in 50ms:
---
      21

thinking
**Summarizing prioritized findings and fixes**
codex
**Findings (ordered by severity)**

1. **Critical: multiplayer IPC auth is currently incompatible with the bridge**
- `app/api_ipc.cpp:173` requires auth when `WIBWOB_AUTH_SECRET` is set.
- `tools/room/orchestrator.py:84` always sets `WIBWOB_AUTH_SECRET`.
- `tools/room/state_diff.py:23` and `tools/room/partykit_bridge.py:115` send plain commands with no challenge/HMAC handshake.
- Result: bridge calls can fail repeatedly (`None`/disconnect) and sync can stall.
- Fix: implement auth handshake in Python IPC client before any command/subscribe:
  - read `{"type":"challenge","nonce":"..."}`
  - send `{"type":"auth","hmac":"..."}`
  - require `{"type":"auth_ok"}`.

2. **Critical: `publish_event` can crash process on broken subscriber (SIGPIPE)**
- Raw `::write` in `app/api_ipc.cpp:561` and `app/api_ipc.cpp:580` has no SIGPIPE guard.
- A dead socket can raise SIGPIPE and terminate process.
- Fix: use `send(..., MSG_NOSIGNAL)` (Linux), `SO_NOSIGPIPE` (macOS), or ignore SIGPIPE globally for IPC sockets.

3. **High: event push path mishandles backpressure/partial writes**
- `app/api_ipc.cpp:580` treats any `n >= 0` as success.
- Short writes produce truncated JSON lines; `EAGAIN` subscribers are never drained/dropped.
- Fix: keep per-subscriber output buffer + write offset; drop subscriber on repeated/full-buffer backpressure.

4. **High: ID stability can break during lookup fallback**
- `app/test_pattern_app.cpp:658` clears `winToId`/`idToWin`; `registerWindow` then reassigns IDs (`:641`) and emits `state_changed` (`:645`).
- This can invalidate remote IDs and trigger desync loops.
- Fix: never clear mappings in lookup path; only add missing live windows, and suppress publish during reconciliation.

5. **High: delta apply misses resize and can silently fail remove/update**
- `tools/room/state_diff.py:217` applies only `move_window`, never `resize_window` for changed `w/h`.
- `partykit_bridge.py:189` only logs `FAIL ...`, no recovery/alert.
- Fix: send `resize_window` when dimensions differ; escalate failures (counter + resync/full-state request).

6. **High: IPC parameter encoding is unsafe**
- Server tokenizes on spaces (`app/api_ipc.cpp:343`), but client sends raw values (`tools/room/state_diff.py:57`).
- Chat/text/path with spaces can be truncated/malformed silently.
- Fix: percent-encode params in Python client (or move to JSON IPC).

7. **Medium: async baseline update race in bridge**
- `_sync_state_now` awaits `push_delta` before final baseline write (`tools/room/partykit_bridge.py:111-113`).
- Another coroutine can mutate `last_windows` during await, then stale state overwrites it.
- Fix: protect `last_windows` with `asyncio.Lock` (or set baseline before await and re-check version).

8. **Medium correctness: `text_view` spawn helper appears wrong**
- `api_open_text_view_path` uses `openAnimationFilePath` at `app/test_pattern_app.cpp:2300`, `:2311`, `:2315`.
- So `"type":"text_view"` can create frame animation behavior.
- Fix: add/use a true `openTransparentTextFilePath(...)` path.

---

**Direct answers to your questions**

1. **Remaining event-push robustness issues?** Yes: SIGPIPE risk, partial-write truncation, no backpressure queueing, weak subscriber cleanup semantics.
2. **Race between `event_subscribe_loop` and `poll_loop` on `last_windows`?** Yes, via coroutine interleaving around awaited sends; not a thread race, but still correctness-risky.
3. **Correctness issues in `window_type_registry.cpp`?** Table itself looks consistent; main correctness gap is around linked helper behavior (`text_view` path) and weak bounds parsing (`atoi`/no validation).
4. **Next highest-value improvement?** After immediate hardening fixes above, **P3 (JSON dual-stack IPC)** is highest value: solves encoding fragility, improves JS/TS interop, and enables structured errors/events. Then do P2 (`IWindowTyped`) to remove remaining type-discovery brittleness.
5. **Anything that can cause silent multiplayer failure?** Yes: auth mismatch, ID remap instability, remove/update by unmapped IDs, dropped/partial event writes, and unencoded IPC params.

If you want, I can implement a focused patch set for the top 3 fixes first: Python auth+encoding, C++ safe event writes, and bridge `last_windows` locking.
tokens used
63,723
**Findings (ordered by severity)**

1. **Critical: multiplayer IPC auth is currently incompatible with the bridge**
- `app/api_ipc.cpp:173` requires auth when `WIBWOB_AUTH_SECRET` is set.
- `tools/room/orchestrator.py:84` always sets `WIBWOB_AUTH_SECRET`.
- `tools/room/state_diff.py:23` and `tools/room/partykit_bridge.py:115` send plain commands with no challenge/HMAC handshake.
- Result: bridge calls can fail repeatedly (`None`/disconnect) and sync can stall.
- Fix: implement auth handshake in Python IPC client before any command/subscribe:
  - read `{"type":"challenge","nonce":"..."}`
  - send `{"type":"auth","hmac":"..."}`
  - require `{"type":"auth_ok"}`.

2. **Critical: `publish_event` can crash process on broken subscriber (SIGPIPE)**
- Raw `::write` in `app/api_ipc.cpp:561` and `app/api_ipc.cpp:580` has no SIGPIPE guard.
- A dead socket can raise SIGPIPE and terminate process.
- Fix: use `send(..., MSG_NOSIGNAL)` (Linux), `SO_NOSIGPIPE` (macOS), or ignore SIGPIPE globally for IPC sockets.

3. **High: event push path mishandles backpressure/partial writes**
- `app/api_ipc.cpp:580` treats any `n >= 0` as success.
- Short writes produce truncated JSON lines; `EAGAIN` subscribers are never drained/dropped.
- Fix: keep per-subscriber output buffer + write offset; drop subscriber on repeated/full-buffer backpressure.

4. **High: ID stability can break during lookup fallback**
- `app/test_pattern_app.cpp:658` clears `winToId`/`idToWin`; `registerWindow` then reassigns IDs (`:641`) and emits `state_changed` (`:645`).
- This can invalidate remote IDs and trigger desync loops.
- Fix: never clear mappings in lookup path; only add missing live windows, and suppress publish during reconciliation.

5. **High: delta apply misses resize and can silently fail remove/update**
- `tools/room/state_diff.py:217` applies only `move_window`, never `resize_window` for changed `w/h`.
- `partykit_bridge.py:189` only logs `FAIL ...`, no recovery/alert.
- Fix: send `resize_window` when dimensions differ; escalate failures (counter + resync/full-state request).

6. **High: IPC parameter encoding is unsafe**
- Server tokenizes on spaces (`app/api_ipc.cpp:343`), but client sends raw values (`tools/room/state_diff.py:57`).
- Chat/text/path with spaces can be truncated/malformed silently.
- Fix: percent-encode params in Python client (or move to JSON IPC).

7. **Medium: async baseline update race in bridge**
- `_sync_state_now` awaits `push_delta` before final baseline write (`tools/room/partykit_bridge.py:111-113`).
- Another coroutine can mutate `last_windows` during await, then stale state overwrites it.
- Fix: protect `last_windows` with `asyncio.Lock` (or set baseline before await and re-check version).

8. **Medium correctness: `text_view` spawn helper appears wrong**
- `api_open_text_view_path` uses `openAnimationFilePath` at `app/test_pattern_app.cpp:2300`, `:2311`, `:2315`.
- So `"type":"text_view"` can create frame animation behavior.
- Fix: add/use a true `openTransparentTextFilePath(...)` path.

---

**Direct answers to your questions**

1. **Remaining event-push robustness issues?** Yes: SIGPIPE risk, partial-write truncation, no backpressure queueing, weak subscriber cleanup semantics.
2. **Race between `event_subscribe_loop` and `poll_loop` on `last_windows`?** Yes, via coroutine interleaving around awaited sends; not a thread race, but still correctness-risky.
3. **Correctness issues in `window_type_registry.cpp`?** Table itself looks consistent; main correctness gap is around linked helper behavior (`text_view` path) and weak bounds parsing (`atoi`/no validation).
4. **Next highest-value improvement?** After immediate hardening fixes above, **P3 (JSON dual-stack IPC)** is highest value: solves encoding fragility, improves JS/TS interop, and enables structured errors/events. Then do P2 (`IWindowTyped`) to remove remaining type-discovery brittleness.
5. **Anything that can cause silent multiplayer failure?** Yes: auth mismatch, ID remap instability, remove/update by unmapped IDs, dropped/partial event writes, and unencoded IPC params.

If you want, I can implement a focused patch set for the top 3 fixes first: Python auth+encoding, C++ safe event writes, and bridge `last_windows` locking.
