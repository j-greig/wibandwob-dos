OpenAI Codex v0.101.0 (research preview)
--------
workdir: /Users/james/Repos/wibandwob-dos
model: gpt-5.3-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: medium
reasoning summaries: auto
session id: 019c7267-011c-7601-8d5d-b33ea2e99400
--------
user
Round-4 comprehensive review of WibWob-DOS IPC hardening. We've now applied three rounds of fixes. Read the round-3 summary and verify all fixes are correctly implemented, then find any remaining issues.

## Context files to read first
- CODEX-ANALYSIS-ROUND3-REVIEW.md (summary of round-3 findings and what was fixed)
- codex-review-round3-20260218-201023.log (raw round-3 review log)

## Files changed in round-3 fixes
- tools/room/partykit_bridge.py — async auth handshake in event_subscribe_loop, state_delta lock race fix, chat_receive via exec_command
- tools/room/state_diff.py — resize_window now sends width/height (was w/h)
- app/api_ipc.cpp — EINTR retry in publish_event, auth read loop in authenticate_connection

## All changed files to review
- app/api_ipc.cpp (full)
- app/api_ipc.h
- app/window_type_registry.cpp
- app/test_pattern_app.cpp (findWindowById, registerWindow, api_get_state/windowTypeName)
- tools/room/state_diff.py
- tools/room/partykit_bridge.py
- tests/room/test_state_diff.py (verify test coverage is complete)

## Specific verification questions
1. Does _async_auth_handshake correctly handle the case where no secret is set (early return)?
2. Is the state_delta lock now correct — does it cover the full apply+baseline refresh?
3. Does exec_command correctly route chat_receive? Check command_registry.cpp for the dispatch.
4. Are there any remaining edge cases in the subscribe_events IPC flow on the C++ side?
5. Is there any missing test coverage (auth handshake, async bridge, window type registry)?
6. What is the single most valuable improvement remaining? (P3 JSON IPC, windowTypeName fix, text_view spawn fix, cursor overlay)
7. Are there any issues with the _normalise_win() function in state_diff.py? Does it correctly handle all key combinations?

Read the actual files. Give severity-ranked findings with exact file+line references and concrete fixes. Be exhaustive.
mcp startup: no servers
2026-02-18T20:17:59.195875Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c67d3-e7fb-7423-879a-a3c6997f29d4
2026-02-18T20:17:59.237386Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6171-ccc2-7702-9b67-9c22338e3137
2026-02-18T20:17:59.257387Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c6248-4000-77b0-815a-4015ebbba891

thinking
**Planning parallel file reads**
codex
Reviewing round-3 artifacts and current source now, then I’ll cross-check each requested verification point against exact implementations and tests with line-level references.
exec
/bin/zsh -lc 'ls -1' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "rg --files | rg 'CODEX-ANALYSIS-ROUND3-REVIEW.md|codex-review-round3-20260218-201023.log|app/api_ipc.cpp|app/api_ipc.h|app/window_type_registry.cpp|app/test_pattern_app.cpp|tools/room/state_diff.py|tools/room/partykit_bridge.py|tests/room/test_state_diff.py|app/command_registry.cpp'" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
AGENTS.md
CLAUDE.md
CMakeLists.txt
CODEX-ANALYSIS-ARCHITECTURE-REVIEW.md
CODEX-ANALYSIS-ROUND2-REVIEW.md
CODEX-ANALYSIS-ROUND3-REVIEW.md
README.md
app
build
cache
codex-architecture-review-20260218-194638.log
codex-multiplayer-bugs-20260218-191257.log
codex-review-round2-20260218-200353.log
codex-review-round3-20260218-201023.log
codex-review-round4-20260218-201757.log
codex-window-types-20260218-193804.log
contracts
docs
logs
memories
 succeeded in 51ms:
CODEX-ANALYSIS-ROUND3-REVIEW.md
app/test_pattern_app.cpp
app/command_registry.cpp
app/window_type_registry.cpp
app/api_ipc.cpp
app/api_ipc.h
tools/room/partykit_bridge.py
tools/room/state_diff.py
codex-review-round3-20260218-201023.log
tests/room/test_state_diff.py

thinking
**Planning efficient file reading**
codex
I found all target files; next I’m reading round-3 summary/log and then each code file with line numbers to validate every fix and look for remaining edge cases.
exec
/bin/zsh -lc "nl -ba CODEX-ANALYSIS-ROUND3-REVIEW.md | sed -n '1,260p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba codex-review-round3-20260218-201023.log | sed -n '1,260p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/api_ipc.cpp | sed -n '1,320p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/api_ipc.cpp | sed -n '320,680p'" in /Users/james/Repos/wibandwob-dos succeeded in 50ms:
     1	# Codex Round-3 Review: IPC Hardening Verification
     2	
     3	**Raw log**: `codex-review-round3-20260218-201023.log`
     4	**Token cost**: ~40,087
     5	**Model**: gpt-5.3-codex
     6	
     7	## Context
     8	
     9	Verification review of all round-2 fixes (SIGPIPE, partial writes, HMAC auth, asyncio.Lock,
    10	ID stability, resize_window, percent-encoding, WindowTypeRegistry). Looking for remaining issues.
    11	
    12	## Findings (Prioritised)
    13	
    14	| # | Severity | Finding |
    15	|---|----------|---------|
    16	| 1 | Critical | `event_subscribe_loop` sends `subscribe_events` before auth handshake — subscription silently fails when `WIBWOB_AUTH_SECRET` is set |
    17	| 2 | High | `resize_window` IPC sends `w`/`h` but server expects `width`/`height` — remote resize deltas fail |
    18	| 3 | High | `state_delta` apply in `receive_loop` runs outside `_state_lock` — race with poll/event loops |
    19	| 4 | Medium | `chat_receive` sent as `cmd:chat_receive` but IPC parser has no such branch — must use `cmd:exec_command name=chat_receive` |
    20	| 5 | Medium | `publish_event` drops subscriber on `EINTR` — should retry write |
 succeeded in 50ms:
     1	#include "api_ipc.h"
     2	#include "command_registry.h"
     3	#include "window_type_registry.h"
     4	
     5	#ifndef _WIN32
     6	#include <sys/socket.h>
     7	#include <sys/stat.h>
     8	#include <sys/un.h>
     9	#include <fcntl.h>
    10	#include <unistd.h>
    11	#include <errno.h>
    12	#endif
    13	
    14	#ifdef __APPLE__
    15	#include <CommonCrypto/CommonHMAC.h>
    16	#else
    17	#include <openssl/hmac.h>
    18	#endif
    19	
    20	#include <cstring>
 succeeded in 50ms:
     1	OpenAI Codex v0.101.0 (research preview)
     2	--------
     3	workdir: /Users/james/Repos/wibandwob-dos
     4	model: gpt-5.3-codex
     5	provider: openai
     6	approval: never
     7	sandbox: workspace-write [workdir, /tmp, $TMPDIR]
     8	reasoning effort: medium
     9	reasoning summaries: auto
    10	session id: 019c7260-0e83-7e92-83ea-dc24d5732969
    11	--------
    12	user
    13	Round-3 comprehensive review of WibWob-DOS IPC hardening. We've just applied a large batch of fixes to the multiplayer sync layer. Please review the current state of ALL changed files and identify any remaining issues.
    14	
    15	## What was fixed in this session
    16	1. P0: WindowTypeRegistry (app/window_type_registry.h + .cpp) — data-driven type dispatch
    17	2. P1: Event push (app/api_ipc.h/cpp, tools/room/partykit_bridge.py) — subscribe_events + publish_event
    18	3. Round-2 hardening:
    19	   - SIGPIPE protection in publish_event (MSG_NOSIGNAL / SO_NOSIGPIPE)
    20	   - Partial write loop + backpressure drop in publish_event
 succeeded in 52ms:
   320	    if (fd < 0) {
   321	        return; // EAGAIN expected in non-blocking mode
   322	    }
   323	
   324	    // Authenticate if secret is set.
   325	    if (auth_required()) {
   326	        if (!authenticate_connection(fd)) {
   327	            std::string err = "{\"error\":\"auth_failed\"}\n";
   328	            ::write(fd, err.c_str(), err.size());
   329	            ::close(fd);
   330	            return;
   331	        }
   332	    }
   333	
   334	    // Read a single line command.
   335	    char buf[2048];
   336	    ssize_t n = ::read(fd, buf, sizeof(buf)-1);
   337	    if (n <= 0) {
   338	        ::close(fd);
   339	        return;

thinking
**Expanding file content extraction**
codex
I’ve confirmed the IPC-side fixes in `api_ipc.cpp`; now I’m validating Python bridge behavior (`_async_auth_handshake`, lock scope, `chat_receive`) plus command dispatch and tests for coverage gaps.
exec
/bin/zsh -lc "nl -ba tools/room/partykit_bridge.py | sed -n '1,340p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba tools/room/state_diff.py | sed -n '1,360p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/command_registry.cpp | sed -n '1,320p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba tests/room/test_state_diff.py | sed -n '1,340p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
     1	#!/usr/bin/env python3
     2	# /// script
     3	# requires-python = ">=3.11"
     4	# dependencies = ["websockets>=12"]
     5	# ///
     6	"""
     7	PartyKit bridge for WibWob-DOS multiplayer rooms (E008 F02).
     8	
     9	Runs as a sidecar alongside a WibWob instance. Polls local IPC state,
    10	diffs it, and pushes state_delta messages to PartyKit. Also receives
    11	remote deltas from PartyKit and applies them to the local instance via IPC.
    12	
    13	Usage (spawned by orchestrator):
    14	    uv run tools/room/partykit_bridge.py
    15	
    16	Environment:
    17	    WIBWOB_INSTANCE      — instance ID (e.g. "1"), drives /tmp/wibwob_1.sock
    18	    WIBWOB_PARTYKIT_URL  — PartyKit server URL (e.g. https://wibwob.user.partykit.dev)
    19	    WIBWOB_PARTYKIT_ROOM — PartyKit room/Durable Object key (e.g. "wibwob-shared")
    20	    WIBWOB_AUTH_SECRET   — shared HMAC secret for IPC auth (optional)
 succeeded in 51ms:
     1	"""
     2	State diffing utilities for WibWob-DOS multiplayer sync (E008 F03).
     3	
     4	Extracts window state from IPC get_state responses, computes minimal
     5	add/remove/update deltas, and applies remote deltas to a local instance
     6	via IPC commands.
     7	
     8	Used by partykit_bridge.py and any future sync transport.
     9	"""
    10	
    11	import hashlib
    12	import hmac as _hmac
    13	import json
    14	import socket
    15	import os
    16	from typing import Any
    17	from urllib.parse import quote as _urlencode
    18	
    19	
    20	IPC_TIMEOUT = 2.0
 succeeded in 51ms:
     1	"""Tests for F03: State diffing module (E008)."""
     2	
     3	import json
     4	import socket
     5	import sys
     6	import threading
     7	from pathlib import Path
     8	from unittest.mock import patch, MagicMock
     9	
    10	import pytest
    11	
    12	sys.path.insert(0, str(Path(__file__).parent.parent.parent / "tools" / "room"))
    13	from state_diff import (
    14	    windows_from_state,
    15	    state_hash,
    16	    compute_delta,
    17	    apply_delta,
    18	    apply_delta_to_ipc,
    19	    _encode_param,
    20	    ipc_command,
 succeeded in 51ms:
     1	#include "command_registry.h"
     2	
     3	#include "api_ipc.h"
     4	
     5	#include <sstream>
     6	
     7	extern void api_cascade(TTestPatternApp& app);
     8	extern void api_toggle_scramble(TTestPatternApp& app);
     9	extern void api_expand_scramble(TTestPatternApp& app);
    10	extern std::string api_scramble_say(TTestPatternApp& app, const std::string& text);
    11	extern std::string api_scramble_pet(TTestPatternApp& app);
    12	extern std::string api_chat_receive(TTestPatternApp& app, const std::string& sender, const std::string& text);
    13	extern void api_tile(TTestPatternApp& app);
    14	extern void api_close_all(TTestPatternApp& app);
    15	extern void api_save_workspace(TTestPatternApp& app);
    16	extern bool api_open_workspace_path(TTestPatternApp& app, const std::string& path);
    17	extern void api_screenshot(TTestPatternApp& app);
    18	extern void api_set_pattern_mode(TTestPatternApp& app, const std::string& mode);
    19	extern std::string api_set_theme_mode(TTestPatternApp& app, const std::string& mode);
    20	extern std::string api_set_theme_variant(TTestPatternApp& app, const std::string& variant);
exec
/bin/zsh -lc "nl -ba tests/room/test_state_diff.py | sed -n '340,520p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
   340	                MockSocket.return_value.__enter__ = MagicMock(return_value=mock_sock)
   341	                MockSocket.return_value = mock_sock
   342	                # _ipc_auth_handshake returns True immediately when no secret
   343	                from state_diff import _ipc_auth_handshake
   344	                result = _ipc_auth_handshake(mock_sock)
   345	                assert result is True
   346	                mock_sock.recv.assert_not_called()
   347	        finally:
   348	            sd._AUTH_SECRET = original_secret
   349	
   350	    def _make_auth_server(self, secret: str) -> tuple:
   351	        """Create a real Unix socket pair that performs the HMAC handshake server-side."""
   352	        import hmac, hashlib, tempfile, os
   353	        sock_path = tempfile.mktemp(suffix=".sock")
   354	        server = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
   355	        server.bind(sock_path)
   356	        server.listen(1)
   357	
   358	        nonce = "deadbeef0123456789abcdef"
   359	

thinking
**Identifying header and registry usage**
exec
/bin/zsh -lc "nl -ba app/window_type_registry.cpp | sed -n '1,280p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/api_ipc.h | sed -n '1,220p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '620,760p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'rg -n "findWindowById|registerWindow|windowTypeName|api_get_state|api_resize_window|api_move_window|api_close_window|idToWin|winToId|api_chat_receive" app/test_pattern_app.cpp' in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
     1	// Window type registry — single source of truth for all spawnable window types.
     2	// Keeps api_ipc.cpp free of per-type knowledge: adding a new type only requires
     3	// a new entry in the k_specs table below.
     4	
     5	#include "window_type_registry.h"
     6	
     7	// tvision for TRect
     8	#define Uses_TRect
     9	#include <tvision/tv.h>
    10	
    11	#include <cstdlib>  // atoi
    12	#include <cstring>  // strcmp
    13	
    14	// ── Extern declarations for spawn helpers in test_pattern_app.cpp ─────────────
    15	
    16	class TTestPatternApp; // forward decl (full type used only by called functions)
    17	
    18	extern void api_spawn_test(TTestPatternApp&, const TRect*);
    19	extern void api_spawn_gradient(TTestPatternApp&, const std::string&, const TRect*);
    20	extern void api_open_animation_path(TTestPatternApp&, const std::string&, const TRect*);
 succeeded in 51ms:
     1	// Unix domain socket IPC server with optional HMAC challenge-response auth.
     2	// Protocol: cmd:<name> [key=value ...]\n
     3	// Auth: when WIBWOB_AUTH_SECRET is set, new connections must complete a
     4	//       challenge-response handshake before commands are accepted.
     5	#pragma once
     6	
     7	#include <string>
     8	#include <set>
     9	#include <vector>
    10	#include <cstdint>
    11	
    12	class TTestPatternApp;
    13	
    14	class ApiIpcServer {
    15	public:
    16	    explicit ApiIpcServer(TTestPatternApp* app);
    17	    ~ApiIpcServer();
    18	
    19	    // Start listening on a Unix socket path. Returns false on failure.
    20	    bool start(const std::string& path = "/tmp/test_pattern_app.sock");
 succeeded in 51ms:
   620	                customMenuBar->setMood(mood, durationMs);
   621	            }
   622	        }
   623	    }
   624	
   625	    // Chat log for multiplayer relay (outgoing messages from local Scramble)
   626	    struct ChatEntry { int seq; std::string sender; std::string text; };
   627	    std::deque<ChatEntry> chatLog_;
   628	    int chatSeq_ = 0;
   629	    static constexpr int kChatLogMax = 50;
   630	
   631	    // API/IPC registry for per-window control
   632	    int apiIdCounter = 1;
   633	    std::map<TWindow*, std::string> winToId;
   634	    std::map<std::string, TWindow*> idToWin;
   635	    
   636	    std::string registerWindow(TWindow* w) {
   637	        if (!w) return std::string();
   638	        auto it = winToId.find(w);
   639	        if (it != winToId.end()) return it->second;
 succeeded in 52ms:
633:    std::map<TWindow*, std::string> winToId;
634:    std::map<std::string, TWindow*> idToWin;
636:    std::string registerWindow(TWindow* w) {
638:        auto it = winToId.find(w);
639:        if (it != winToId.end()) return it->second;
643:        winToId[w] = id;
644:        idToWin[id] = w;
653:    TWindow* findWindowById(const std::string& id) {
654:        auto it = idToWin.find(id);
655:        if (it != idToWin.end()) return it->second;
664:                if (w && winToId.find(w) == winToId.end()) {
669:                    winToId[w] = new_id;
670:                    idToWin[new_id] = w;
675:        it = idToWin.find(id);
676:        if (it != idToWin.end()) return it->second;
696:    friend std::string api_chat_receive(TTestPatternApp&, const std::string&, const std::string&);
704:    friend std::string api_get_state(TTestPatternApp&);
705:    friend std::string api_move_window(TTestPatternApp&, const std::string&, int, int);
706:    friend std::string api_resize_window(TTestPatternApp&, const std::string&, int, int);
708:    friend std::string api_close_window(TTestPatternApp&, const std::string&);

thinking
**Planning code range extraction**
exec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '2360,2575p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "nl -ba app/test_pattern_app.cpp | sed -n '1180,1335p'" in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc "rg -n \"subscribe_events|publish_event|event_subscribers_|authenticate_connection|SO_RCVTIMEO|read\\(|write\\(|recv\\(\" app/api_ipc.cpp" in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
  2360	    };
  2361	    std::string response = petReactions[std::rand() % 5];
  2362	
  2363	    if (app.scrambleWindow->getView()) {
  2364	        app.scrambleWindow->getView()->setPose(spDefault);
  2365	        app.scrambleWindow->getView()->say(response);
  2366	    }
  2367	    auto* msgView = app.scrambleWindow->getMessageView();
  2368	    if (msgView) msgView->addMessage("scramble", response);
  2369	    return response;
  2370	}
  2371	
  2372	std::string api_chat_receive(TTestPatternApp& app, const std::string& sender, const std::string& text) {
  2373	    // Display a remote chat message in Scramble without AI processing.
  2374	    if (!app.scrambleWindow) return "err scramble not open";
  2375	    auto* msgView = app.scrambleWindow->getMessageView();
  2376	    if (!msgView) return "err no message view";
  2377	    msgView->addMessage(sender, text);
  2378	    return "ok";
  2379	}
 succeeded in 51ms:
  1180	                    params.dimensionCorruption = 0.3f;
  1181	                    getGlitchEngine().setGlitchParams(params);
  1182	                    messageBox("Diagonal scatter applied! Creates diagonal streaking effects.", mfInformation | mfOKButton);
  1183	                }
  1184	                clearEvent(event);
  1185	                break;
  1186	            }
  1187	            case cmCaptureGlitchedFrame: {
  1188	                TView* activeView = deskTop->current;
  1189	                std::string captured = captureGlitchedFrame(activeView);
  1190	                
  1191	                // Save to file with timestamp
  1192	                auto now = std::chrono::system_clock::now();
  1193	                auto time_t = std::chrono::system_clock::to_time_t(now);
  1194	                std::ostringstream filename;
  1195	                filename << "glitched_frame_" << std::put_time(std::localtime(&time_t), "%Y%m%d_%H%M%S") << ".txt";
  1196	                
  1197	                if (getFrameCapture().saveFrame(getFrameCapture().captureScreen(), filename.str(), 
  1198	                                               CaptureOptions{CaptureFormat::AnsiEscapes, true, false, true, true, true})) {
  1199	                    messageBox(("Frame captured to: " + filename.str()).c_str(), mfInformation | mfOKButton);
 succeeded in 51ms:
172:bool ApiIpcServer::authenticate_connection(int fd) {
182:    ::setsockopt(fd, SOL_SOCKET, SO_RCVTIMEO, &tv, sizeof(tv));
187:    if (::write(fd, challenge.c_str(), challenge.size()) < 0) return false;
193:        ssize_t n = ::read(fd, buf, sizeof(buf) - 1);
244:    ::write(fd, ok_msg.c_str(), ok_msg.size());
326:        if (!authenticate_connection(fd)) {
328:            ::write(fd, err.c_str(), err.size());
336:    ssize_t n = ::read(fd, buf, sizeof(buf)-1);
562:    if (cmd == "subscribe_events") {
564:        // Set non-blocking so publish_event doesn't stall the event loop.
572:        ::write(fd, ack, std::strlen(ack));
573:        event_subscribers_.push_back(fd);
577:    ::write(fd, resp.c_str(), resp.size());
582:void ApiIpcServer::publish_event(const char* event_type, const std::string& payload_json) {
584:    if (event_subscribers_.empty()) return;
592:    for (auto it = event_subscribers_.begin(); it != event_subscribers_.end(); ) {
606:            ssize_t n = ::write(fd, data + written, static_cast<size_t>(total - written));
625:            it = event_subscribers_.erase(it);
636:    for (int sub_fd : event_subscribers_) ::close(sub_fd);
637:    event_subscribers_.clear();

thinking
**Inspecting tests and API for bridge issues**
codex
I’ve validated the core code paths and now I’m checking for residual test gaps beyond `test_state_diff.py`, especially around async bridge behavior and window type registry integration.
exec
/bin/zsh -lc 'rg --files tests | sort' in /Users/james/Repos/wibandwob-dosexec
/bin/zsh -lc 'rg -n "partykit_bridge|_async_auth_handshake|event_subscribe_loop|window_type_registry|find_window_type_by_name|create_window|subscribe_events" tests app | head -n 200' in /Users/james/Repos/wibandwob-dos succeeded in 52ms:
tests/__init__.py
tests/contract/test_actor_attribution.py
tests/contract/test_browser_ai_actions.py
tests/contract/test_browser_ai_tools.py
tests/contract/test_browser_cache.py
tests/contract/test_browser_copy_ui_contract.py
tests/contract/test_browser_core.py
tests/contract/test_browser_gallery.py
tests/contract/test_browser_image_backend.py
tests/contract/test_browser_image_modes.py
tests/contract/test_browser_render_bundle_schema.py
tests/contract/test_browser_render_modes.py
tests/contract/test_browser_window_skeleton.py
tests/contract/test_capabilities_schema.py
tests/contract/test_instance_isolation.py
tests/contract/test_mcp_registry_parity.py
tests/contract/test_mcp_registry_parity_full.py
tests/contract/test_mcp_tool_registration.py
tests/contract/test_no_hardcoded_migrated_command_lists.py
tests/contract/test_parity_drift.py
 succeeded in 52ms:
tests/test_browser_window.py:25:    """AC-1: create_window type=browser is recognized in Python schemas."""
tests/test_browser_window.py:53:        cmd = "cmd:create_window type=browser"
tests/test_browser_window.py:54:        assert "cmd:create_window" in cmd
tests/test_browser_window.py:59:        cmd = "cmd:create_window type=browser x=5 y=3 w=60 h=20"
app/CMakeLists.txt:15:    window_type_registry.cpp
app/wibwob-mcp-native-tools-prd.md:37:- Allowed tools: dedupe and pass only the defined tool names; keep MCP names stable (`tui_create_window`, etc.).
tests/room/test_state_diff.py:197:        assert any(c == "create_window" for c, _ in calls)
tests/room/test_state_diff.py:223:        assert any("create_window" in a for a in applied)
tests/room/test_state_diff.py:241:        assert any("create_window" in a for a in applied)
tests/room/test_state_diff.py:263:        create = [p for c, p in calls if c == "create_window"]
tests/room/test_partykit_bridge.py:12:from partykit_bridge import (
tests/room/test_partykit_bridge.py:112:    def test_add_calls_create_window(self):
tests/room/test_partykit_bridge.py:117:        assert any(c == "create_window" for c, _ in calls)
tests/room/test_partykit_bridge.py:166:        assert any("partykit_bridge" in c for c in cmds_flat), \
tests/room/test_partykit_bridge.py:167:            f"Expected partykit_bridge in spawn calls, got: {cmds_flat}"
tests/room/test_partykit_bridge.py:189:        assert not any("partykit_bridge" in c for c in cmds_flat), \
tests/room/test_partykit_bridge.py:222:        import partykit_bridge
tests/room/test_partykit_bridge.py:223:        assert partykit_bridge.RECONNECT_DELAY <= 5
tests/room/test_partykit_bridge.py:262:        (e.g. 'w2') when create_window is called, but the remote delta carried
tests/room/test_partykit_bridge.py:275:        # C++ assigns its own ID "w2" (not "w1") when create_window is called

thinking
**Reviewing test coverage for handshake and lock**
codex
I found additional bridge tests, so I’m reading them before concluding coverage gaps to avoid false negatives.
exec
/bin/zsh -lc "nl -ba tests/room/test_partykit_bridge.py | sed -n '1,360p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
     1	"""Tests for F02: PartyKit bridge — state diffing, delta application, WS URL building (E008)."""
     2	
     3	import asyncio
     4	import json
     5	import sys
     6	from pathlib import Path
     7	from unittest.mock import AsyncMock, MagicMock, patch
     8	
     9	import pytest
    10	
    11	sys.path.insert(0, str(Path(__file__).parent.parent.parent / "tools" / "room"))
    12	from partykit_bridge import (
    13	    build_ws_url,
    14	    compute_delta,
    15	    windows_from_state,
    16	    apply_delta_to_ipc,
    17	    PartyKitBridge,
    18	)
    19	
    20	# ── URL building ──────────────────────────────────────────────────────────────
exec
/bin/zsh -lc "nl -ba tests/room/test_chat_relay.py | sed -n '1,280p'" in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
     1	"""Tests for F04: Chat relay — bridge forwards local chat to PartyKit, applies remote chat via IPC."""
     2	
     3	import asyncio
     4	import json
     5	import sys
     6	from pathlib import Path
     7	from unittest.mock import AsyncMock, patch
     8	
     9	import pytest
    10	
    11	sys.path.insert(0, str(Path(__file__).parent.parent.parent / "tools" / "room"))
    12	from partykit_bridge import PartyKitBridge
    13	
    14	
    15	# ── Helpers ───────────────────────────────────────────────────────────────────
    16	
    17	def make_bridge() -> PartyKitBridge:
    18	    b = PartyKitBridge("1", "http://localhost:1999", "test-room")
    19	    b._ws = AsyncMock()
    20	    b._ws.send = AsyncMock()

thinking
**Identifying outdated tests and gaps**
codex
I found bridge tests too; I’m running the relevant pytest subset now to verify whether round-3 behavior is actually covered and whether expectations still match the current implementation.
exec
/bin/zsh -lc 'pytest -q tests/room/test_state_diff.py tests/room/test_partykit_bridge.py tests/room/test_chat_relay.py' in /Users/james/Repos/wibandwob-dos exited 127 in 51ms:
zsh:1: command not found: pytest

thinking
**Testing with uv run**
codex
`pytest` isn’t available directly in this shell, so I’m retrying through `uv run` to get an actual test result for these review points.
exec
/bin/zsh -lc 'uv run pytest -q tests/room/test_state_diff.py tests/room/test_partykit_bridge.py tests/room/test_chat_relay.py' in /Users/james/Repos/wibandwob-dos exited 2 in 51ms:
error: Failed to spawn: `pytest`
  Caused by: No such file or directory (os error 2)

thinking
**Identifying multiple subscribe-events edge cases**
exec
/bin/zsh -lc 'rg -n "windowTypeName|find_window_type_by_name|window_type_registry|text_view|monster_portal|create_window type" tests app/test_pattern_app.cpp app/window_type_registry.cpp tests/contract tests/room | head -n 200' in /Users/james/Repos/wibandwob-dos succeeded in 51ms:
app/window_type_registry.cpp:5:#include "window_type_registry.h"
app/window_type_registry.cpp:21:extern void api_open_text_view_path(TTestPatternApp&, const std::string&, const TRect*);
app/window_type_registry.cpp:36:extern void api_spawn_monster_portal(TTestPatternApp&, const TRect*);
app/window_type_registry.cpp:72:static const char* spawn_text_view(TTestPatternApp& app,
app/window_type_registry.cpp:76:    TRect r; api_open_text_view_path(app, it->second, opt_bounds(kv, r)); return nullptr;
app/window_type_registry.cpp:149:static const char* spawn_monster_portal(TTestPatternApp& app,
app/window_type_registry.cpp:151:    TRect r; api_spawn_monster_portal(app, opt_bounds(kv, r)); return nullptr;
app/window_type_registry.cpp:161:    { "text_view",         spawn_text_view        },
app/window_type_registry.cpp:176:    { "monster_portal",    spawn_monster_portal   },
app/window_type_registry.cpp:190:const WindowTypeSpec* find_window_type_by_name(const std::string& name) {
app/test_pattern_app.cpp:61:#include "generative_monster_portal_view.h"
app/test_pattern_app.cpp:79:#include "transparent_text_view.h"
app/test_pattern_app.cpp:687:    friend void api_open_text_view_path(TTestPatternApp&, const std::string&, const TRect* bounds);
app/test_pattern_app.cpp:724:    friend void api_spawn_monster_portal(TTestPatternApp&, const TRect* bounds);
app/test_pattern_app.cpp:2297:void api_open_text_view_path(TTestPatternApp& app, const std::string& path, const TRect* bounds) {
app/test_pattern_app.cpp:2398:static const char* windowTypeName(TWindow* w) {
app/test_pattern_app.cpp:2406:    if (dynamic_cast<TTransparentTextWindow*>(w)) return "text_view";
app/test_pattern_app.cpp:2435:    if (HAS_CHILD_VIEW(TGenerativeMonsterPortalView)) return "monster_portal";
app/test_pattern_app.cpp:2480:             << ",\"type\":\"" << windowTypeName(w) << "\""
app/test_pattern_app.cpp:3200:// Generative / animated art windows — spawnable via IPC create_window type=X

thinking
**Compiling severity-ranked IPC findings**
codex
**Findings (severity-ranked)**

1. **High**: `subscribe_events` command intake is still single-read, not line-framed, so fragmented socket reads can silently break subscription setup.  
`app/api_ipc.cpp:334`, `app/api_ipc.cpp:336`, `app/api_ipc.cpp:342`  
Fix: read in a loop until `\n` (with max frame size), then parse exactly one frame.

2. **Medium**: dead event subscriber FDs are only cleaned up on later `publish_event`, so quiet periods can accumulate stale FDs.  
`app/api_ipc.cpp:573`, `app/api_ipc.cpp:582`, `app/api_ipc.cpp:623`  
Fix: add proactive pruning (periodic liveness check / `poll`/`recv(MSG_PEEK)` cleanup) before appending new subscriber or on each IPC poll tick.

3. **Medium**: chat relay tests are stale after the `exec_command` migration; they still assert direct `chat_receive`.  
`tests/room/test_chat_relay.py:140`, `tests/room/test_chat_relay.py:142`, `tests/room/test_chat_relay.py:187`  
Fix: update expected call to `ipc_command(sock, "exec_command", {"name":"chat_receive", ...})`.

4. **Medium (coverage gap)**: no direct tests for async auth handshake/order in event subscription path (`_async_auth_handshake` + `event_subscribe_loop`).  
`tools/room/partykit_bridge.py:46`, `tools/room/partykit_bridge.py:159`, `tests/room/test_partykit_bridge.py:1`  
Fix: add async unit tests for challenge/auth_ok success, no-secret fast path, auth failure, and “subscribe sent only after auth_ok”.

5. **Low**: `_normalise_win` can discard valid `width`/`height` when `w`/`h` keys exist but are unusable (`None`/bad type).  
`tools/room/state_diff.py:134`, `tools/room/state_diff.py:136`, `tools/room/state_diff.py:138`, `tools/room/state_diff.py:140`  
Fix: only prefer existing `w`/`h` if valid numeric values; otherwise backfill from `width`/`height`.

6. **Low**: nonce eviction is lexicographic, not age-based, due `std::set`, so replay window management is imprecise under high churn.  
`app/api_ipc.cpp:235`, `app/api_ipc.cpp:239`  
Fix: track nonce insertion order (queue/deque + set) and evict oldest-by-time.

**Verification answers**

1. Yes. `_async_auth_handshake` correctly early-returns when no secret is set.  
`tools/room/partykit_bridge.py:54`

2. Yes. `state_delta` lock now covers full apply + baseline refresh.  
`tools/room/partykit_bridge.py:241`, `tools/room/partykit_bridge.py:246`, `tools/room/partykit_bridge.py:248`

3. Yes. `chat_receive` is now routed through `exec_command`, and registry dispatch exists.  
`tools/room/partykit_bridge.py:258`, `app/command_registry.cpp:146`

4. Remaining C++ subscribe edge cases: fragmented command read and lazy stale-FD cleanup (findings #1 and #2).

5. Coverage is incomplete for async auth subscription path and window type registry parity; plus chat relay assertions are outdated (findings #3 and #4).

6. Most valuable next improvement: **P3 JSON dual-stack IPC**. It removes token/field-name drift classes (`w/h` vs `width/height`, command framing fragility) at once.

7. `_normalise_win()` is mostly correct for common combinations, but not all key-quality combinations (finding #5).

Could not execute pytest in this environment (`pytest` not installed via shell or `uv run`).
tokens used
61,236
**Findings (severity-ranked)**

1. **High**: `subscribe_events` command intake is still single-read, not line-framed, so fragmented socket reads can silently break subscription setup.  
`app/api_ipc.cpp:334`, `app/api_ipc.cpp:336`, `app/api_ipc.cpp:342`  
Fix: read in a loop until `\n` (with max frame size), then parse exactly one frame.

2. **Medium**: dead event subscriber FDs are only cleaned up on later `publish_event`, so quiet periods can accumulate stale FDs.  
`app/api_ipc.cpp:573`, `app/api_ipc.cpp:582`, `app/api_ipc.cpp:623`  
Fix: add proactive pruning (periodic liveness check / `poll`/`recv(MSG_PEEK)` cleanup) before appending new subscriber or on each IPC poll tick.

3. **Medium**: chat relay tests are stale after the `exec_command` migration; they still assert direct `chat_receive`.  
`tests/room/test_chat_relay.py:140`, `tests/room/test_chat_relay.py:142`, `tests/room/test_chat_relay.py:187`  
Fix: update expected call to `ipc_command(sock, "exec_command", {"name":"chat_receive", ...})`.

4. **Medium (coverage gap)**: no direct tests for async auth handshake/order in event subscription path (`_async_auth_handshake` + `event_subscribe_loop`).  
`tools/room/partykit_bridge.py:46`, `tools/room/partykit_bridge.py:159`, `tests/room/test_partykit_bridge.py:1`  
Fix: add async unit tests for challenge/auth_ok success, no-secret fast path, auth failure, and “subscribe sent only after auth_ok”.

5. **Low**: `_normalise_win` can discard valid `width`/`height` when `w`/`h` keys exist but are unusable (`None`/bad type).  
`tools/room/state_diff.py:134`, `tools/room/state_diff.py:136`, `tools/room/state_diff.py:138`, `tools/room/state_diff.py:140`  
Fix: only prefer existing `w`/`h` if valid numeric values; otherwise backfill from `width`/`height`.

6. **Low**: nonce eviction is lexicographic, not age-based, due `std::set`, so replay window management is imprecise under high churn.  
`app/api_ipc.cpp:235`, `app/api_ipc.cpp:239`  
Fix: track nonce insertion order (queue/deque + set) and evict oldest-by-time.

**Verification answers**

1. Yes. `_async_auth_handshake` correctly early-returns when no secret is set.  
`tools/room/partykit_bridge.py:54`

2. Yes. `state_delta` lock now covers full apply + baseline refresh.  
`tools/room/partykit_bridge.py:241`, `tools/room/partykit_bridge.py:246`, `tools/room/partykit_bridge.py:248`

3. Yes. `chat_receive` is now routed through `exec_command`, and registry dispatch exists.  
`tools/room/partykit_bridge.py:258`, `app/command_registry.cpp:146`

4. Remaining C++ subscribe edge cases: fragmented command read and lazy stale-FD cleanup (findings #1 and #2).

5. Coverage is incomplete for async auth subscription path and window type registry parity; plus chat relay assertions are outdated (findings #3 and #4).

6. Most valuable next improvement: **P3 JSON dual-stack IPC**. It removes token/field-name drift classes (`w/h` vs `width/height`, command framing fragility) at once.

7. `_normalise_win()` is mostly correct for common combinations, but not all key-quality combinations (finding #5).

Could not execute pytest in this environment (`pytest` not installed via shell or `uv run`).
